# decoder = DataDecoder.new(data, @imei)
# decoder.decode

# Results example:
# [{:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:26", :priority=>0, :gps_data=>{:longitude=>24.4257566, :latitude=>58.8435066, :altitude=>32, :angle=>197, :satellites=>19, :speed=>99}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>4, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13863, 67=>4066, 68=>0, 241=>24801, 199=>111, 16=>774626}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:30", :priority=>0, :gps_data=>{:longitude=>24.4252016, :latitude=>58.8425816, :altitude=>33, :angle=>197, :satellites=>19, :speed=>97}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>4, 200=>0, 69=>1, 250=>1, 181=>4, 182=>2, 66=>13859, 67=>4066, 68=>0, 241=>24801, 199=>107, 16=>774733}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:34", :priority=>0, :gps_data=>{:longitude=>24.4246566, :latitude=>58.8416783, :altitude=>33, :angle=>197, :satellites=>19, :speed=>95}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>4, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13848, 67=>4066, 68=>0, 241=>24801, 199=>105, 16=>774838}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:38", :priority=>0, :gps_data=>{:longitude=>24.4241016, :latitude=>58.8407916, :altitude=>30, :angle=>197, :satellites=>18, :speed=>92}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>4, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13843, 67=>4066, 68=>0, 241=>24801, 199=>104, 16=>774942}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:42", :priority=>0, :gps_data=>{:longitude=>24.4235516, :latitude=>58.8399133, :altitude=>29, :angle=>197, :satellites=>16, :speed=>90}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>4, 182=>3, 66=>13846, 67=>4066, 68=>0, 241=>24801, 199=>103, 16=>775045}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:47", :priority=>0, :gps_data=>{:longitude=>24.422915, :latitude=>58.8388483, :altitude=>30, :angle=>197, :satellites=>16, :speed=>89}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>3, 66=>13843, 67=>4066, 68=>0, 241=>24801, 199=>123, 16=>775168}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:52", :priority=>0, :gps_data=>{:longitude=>24.4222633, :latitude=>58.8377783, :altitude=>33, :angle=>197, :satellites=>17, :speed=>88}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>4, 182=>3, 66=>13850, 67=>4066, 68=>0, 241=>24801, 199=>125, 16=>775293}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:05:57", :priority=>0, :gps_data=>{:longitude=>24.4216666, :latitude=>58.8367316, :altitude=>29, :angle=>197, :satellites=>19, :speed=>86}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13840, 67=>4066, 68=>0, 241=>24801, 199=>121, 16=>775414}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:02", :priority=>0, :gps_data=>{:longitude=>24.42104, :latitude=>58.8357233, :altitude=>32, :angle=>197, :satellites=>19, :speed=>85}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13854, 67=>4066, 68=>0, 241=>24801, 199=>118, 16=>775532}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:07", :priority=>0, :gps_data=>{:longitude=>24.4204033, :latitude=>58.834715, :altitude=>34, :angle=>197, :satellites=>17, :speed=>85}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>3, 66=>13788, 67=>4061, 68=>0, 241=>24801, 199=>118, 16=>775650}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:12", :priority=>0, :gps_data=>{:longitude=>24.41977, :latitude=>58.8336816, :altitude=>31, :angle=>197, :satellites=>18, :speed=>87}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>2, 66=>13840, 67=>4066, 68=>0, 241=>24801, 199=>121, 16=>775771}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:17", :priority=>0, :gps_data=>{:longitude=>24.41911, :latitude=>58.832625, :altitude=>28, :angle=>197, :satellites=>17, :speed=>87}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>4, 182=>2, 66=>13843, 67=>4062, 68=>0, 241=>24801, 199=>123, 16=>775894}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:22", :priority=>0, :gps_data=>{:longitude=>24.4184616, :latitude=>58.83157, :altitude=>24, :angle=>198, :satellites=>15, :speed=>91}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>3, 66=>13848, 67=>4066, 68=>0, 241=>24801, 199=>123, 16=>776017}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:26", :priority=>0, :gps_data=>{:longitude=>24.4179183, :latitude=>58.8306816, :altitude=>22, :angle=>198, :satellites=>14, :speed=>93}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>6, 182=>3, 66=>13844, 67=>4067, 68=>0, 241=>24801, 199=>104, 16=>776121}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:30", :priority=>0, :gps_data=>{:longitude=>24.4173383, :latitude=>58.82979, :altitude=>25, :angle=>197, :satellites=>13, :speed=>94}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>5, 182=>3, 66=>13692, 67=>4065, 68=>0, 241=>24801, 199=>104, 16=>776225}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:34", :priority=>0, :gps_data=>{:longitude=>24.4168166, :latitude=>58.8289183, :altitude=>20, :angle=>198, :satellites=>12, :speed=>95}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>6, 182=>3, 66=>13853, 67=>4066, 68=>0, 241=>24801, 199=>102, 16=>776327}}, {:imei=>"357544374597827", :number_of_rec=>17, :date_time=>"2022-07-05T13:06:38", :priority=>0, :gps_data=>{:longitude=>24.4162416, :latitude=>58.82803, :altitude=>18, :angle=>196, :satellites=>12, :speed=>94}, :io_event_code=>0, :number_of_io_elements=>14, :io_data=>{239=>1, 240=>1, 21=>3, 200=>0, 69=>1, 250=>1, 181=>9, 182=>4, 66=>13846, 67=>4066, 68=>0, 241=>24801, 199=>104, 16=>776431}}]

class DataDecoder
  def initialize(payload, imei)
    @payload = payload
    @imei = imei
    @precision = 10000000.0
  end

  def number_of_rec
    @payload[18..19].to_i(16)
  end

  def number_of_total_rec
    @payload[-10..-9].to_i(16)
  end

  def avl_data
    @payload[20..-9]
  end

  def timestamp(avl_data, position)
    timestamp_hex = avl_data[position..position+15]
    timestamp_decode = timestamp_hex.to_i(16)
    DateTime.strptime(timestamp_decode.to_s, '%Q').strftime('%FT%T')
  end

  def priority(avl_data, position)
    priority_hex = avl_data[position..position+1]
    priority_hex.to_i(16)
  end

  def longitude(avl_data, position)
    longitude_hex = avl_data[position..position+7]
    longitude_decode = longitude_hex.to_i(16)
    longitude_decode / @precision
  end

  def latitude(avl_data, position)
    latitude_hex = avl_data[position..position+7]
    latitude_decode = latitude_hex.to_i(16)
    latitude_decode / @precision
  end

  def altitude(avl_data, position)
    altitude_hex = avl_data[position..position+3]
    altitude_hex.to_i(16)
  end

  def angle(avl_data, position)
    angle_hex = avl_data[position..position+3]
    angle_hex.to_i(16)
  end

  def satellites(avl_data, position)
    satellites_hex = avl_data[position..position+1]
    satellites_hex.to_i(16)
  end

  def speed(avl_data, position)
    speed_hex = avl_data[position..position+3]
    speed_hex.to_i(16)
  end

  def io_event_code(avl_data, position)
    avl_data[position..position + 1].to_i(16)
  end

  def number_of_io_elements(avl_data, position)
    avl_data[position..position + 1].to_i(16)
  end

  def decode
    data = []

    if number_of_rec == number_of_total_rec
      index = 0
      position = 0

      while index < number_of_rec
        # Timestamp
        timestamp = timestamp(avl_data, position)
        position += 16

        # Priority
        priority = priority(avl_data, position)
        position += 2

        # Longitude
        longitude = longitude(avl_data, position)
        position += 8

        # Latitude
        latitude = latitude(avl_data, position)
        position += 8

        # Altitude
        altitude = altitude(avl_data, position)
        position += 4

        # Angle
        angle = angle(avl_data, position)
        position += 4

        # Satellites
        satellites = satellites(avl_data, position)
        position += 2

        # Speed
        speed = speed(avl_data, position)
        position += 4

        # SensorsData

        # IO element ID of Event generated
        io_event_code = avl_data[position..position + 1].to_i(16)
        position += 2

        number_of_io_elements = avl_data[position..position + 1].to_i(16)
        position += 2

        # 1 Bit
        number_of_io1_bit_elements = avl_data[position..position + 1].to_i(16)
        position += 2
        io_data = {}
        number_of_io1_bit_elements.times do
          io_code = avl_data[position..position + 1].to_i(16)
          position += 2
          io_val = avl_data[position..position + 1].to_i(16)
          position += 2
          io_data[io_code] = io_val
        end

        # 2 Bit
        number_of_io2_bit_elements = avl_data[position..position + 1].to_i(16)
        position += 2

        number_of_io2_bit_elements.times do
          io_code = avl_data[position..position + 1].to_i(16)
          position += 2
          io_val = avl_data[position..position + 3].to_i(16)
          position += 4
          io_data[io_code] = io_val
        end

        # 4 Bit
        number_of_io4_bit_elements = avl_data[position..position + 1].to_i(16)
        position += 2

        number_of_io4_bit_elements.times do
          io_code = avl_data[position..position + 1].to_i(16)
          position += 2
          io_val = avl_data[position..position + 7].to_i(16)
          position += 8
          io_data[io_code] = io_val
        end

        # 8 Bit
        number_of_io8_bit_elements = avl_data[position..position + 1].to_i(16)
        position += 2

        number_of_io8_bit_elements.times do
          io_code = avl_data[position..position + 1].to_i(16)
          position += 2
          io_val = avl_data[position..position + 15].to_i(16)
          position += 16
          io_data[io_code] = io_val
        end

        index += 1

        decoded_data = {
          imei: @imei,
          number_of_rec: number_of_rec,
          date_time: timestamp,
          priority: priority,
          gps_data: {
              longitude: longitude,
              latitude: latitude,
              altitude: altitude,
              angle: angle,
              satellites: satellites,
              speed: speed,
          },
          io_event_code: io_event_code,
          number_of_io_elements: number_of_io_elements,
          io_data: io_data
        }

        data << decoded_data
      end
    end

    return data
  end
end
